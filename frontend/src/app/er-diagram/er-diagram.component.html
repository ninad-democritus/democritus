<!-- ER Diagram Container -->
<div class="er-diagram-container" #diagramContainer>
  <!-- Diagram Actions - Top Controls -->
  <div class="diagram-actions">
    <button 
      (click)="submitChanges()"
      [disabled]="!hasChanges"
      class="control-btn save-btn"
      title="Save Changes">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
      </svg>
    </button>
    
    <button 
      (click)="resetChanges()"
      [disabled]="!hasChanges"
      class="control-btn reset-btn"
      title="Reset Changes">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
      </svg>
    </button>
  </div>

  <!-- Main SVG Diagram Area -->
  <div class="diagram-area">
    <svg class="er-svg" [attr.viewBox]="'0 0 ' + svgWidth + ' ' + svgHeight" preserveAspectRatio="xMidYMid meet" width="100%" height="100%">
      <!-- Background -->
      <rect 
        width="100%" 
        height="100%" 
        fill="var(--bg-page-solid)"
        stroke="none">
      </rect>
      
      <!-- Relationships (drawn first, so they appear behind entities) -->
      <g class="relationships-layer">
        <!-- Inline relationship rendering -->
        <g *ngFor="let relationship of relationships; let i = index" class="relationship-group">
          <!-- Relationship Line -->
          <line
            [attr.x1]="relationship.x1"
            [attr.y1]="relationship.y1"
            [attr.x2]="relationship.x2"
            [attr.y2]="relationship.y2"
            fill="none"
            marker-end="url(#arrowhead)"
            class="relationship-line"
            (click)="onRelationshipClick(relationship)">
          </line>
          
          <!-- Relationship Label -->
          <text 
            [attr.x]="(relationship.x1 + relationship.x2) / 2" 
            [attr.y]="(relationship.y1 + relationship.y2) / 2 - 10"
            fill="var(--text-primary)"
            font-family="var(--font-sans)"
            font-size="12"
            font-weight="500"
            text-anchor="middle"
            class="relationship-label">
            {{ relationship.relationship_type || 'relates to' }}
          </text>
        </g>
        
        <!-- Arrow marker definition -->
        <defs>
          <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
            <polygon points="0 0, 10 3.5, 0 7" fill="var(--color-primary-500)" />
          </marker>
        </defs>
      </g>
      
      
      <!-- Entities (drawn on top of relationships) -->
      <g class="entities-layer">
        <!-- Inline entity rendering for debugging -->
        <g *ngFor="let entity of entities; let i = index" class="entity-group">
          <!-- Entity Background -->
          <rect
            [attr.x]="entity.x"
            [attr.y]="entity.y"
            [attr.width]="entity.width"
            [attr.height]="entity.height"
            class="entity-rect"
            [class.selected]="selectedEntityIndex === i"
            (click)="onEntityClick(i)">
          </rect>
          
          <!-- Entity Header -->
          <rect
            [attr.x]="entity.x"
            [attr.y]="entity.y"
            [attr.width]="entity.width"
            height="40"
            class="entity-header">
          </rect>
          
          <!-- Entity Title -->
          <text
            [attr.x]="entity.x + 12"
            [attr.y]="entity.y + 28"
            class="entity-title">
            {{ entity.name }}
          </text>
          
          <!-- Entity Description -->
          <text
            [attr.x]="entity.x + 12"
            [attr.y]="entity.y + 55"
            class="entity-description">
            {{ entity.description || entity.business_description || 'No description' }}
          </text>
          
          <!-- Add Column Button -->
          <circle
            [attr.cx]="entity.x + entity.width - 20"
            [attr.cy]="entity.y + 20"
            r="8"
            class="add-column-btn"
            (click)="onAddColumn(i)"
            title="Add Column">
          </circle>
          
          <!-- Add Column Icon -->
          <svg 
            [attr.x]="entity.x + entity.width - 27"
            [attr.y]="entity.y + 13"
            width="14" height="14" viewBox="0 0 24 24" class="add-column-icon">
            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
          </svg>
          
          <!-- Columns -->
          <g *ngFor="let column of entity.columns; let colIndex = index" class="column-row">
            <!-- Column Background -->
            <rect 
              [attr.x]="entity.x + 2" 
              [attr.y]="entity.y + 70 + (colIndex * 32)"
              [attr.width]="entity.width - 4" 
              height="30"
              class="column-bg"
              [class.editing]="editingColumn.entityIndex === i && editingColumn.columnIndex === colIndex"
              (click)="startEditingColumn(i, colIndex)">
            </rect>
            
            <!-- Primary Key Icon -->
            <g *ngIf="column.primary_key" class="column-icon">
              <circle 
                [attr.cx]="entity.x + 15" 
                [attr.cy]="entity.y + 85 + (colIndex * 32)" 
                r="6"
                style="fill: var(--color-accent-500); stroke: var(--color-accent-600);">
              </circle>
              <text 
                [attr.x]="entity.x + 15" 
                [attr.y]="entity.y + 89 + (colIndex * 32)" 
                class="key-icon">ðŸ”‘</text>
            </g>
            
            <!-- Required Icon -->
            <g *ngIf="!column.nullable" class="column-icon">
              <circle 
                [attr.cx]="entity.x + (column.primary_key ? 30 : 15)" 
                [attr.cy]="entity.y + 85 + (colIndex * 32)" 
                r="4"
                style="fill: var(--color-error-500);">
              </circle>
              <text 
                [attr.x]="entity.x + (column.primary_key ? 30 : 15)" 
                [attr.y]="entity.y + 88 + (colIndex * 32)" 
                class="required-icon">!</text>
            </g>
            
            <!-- Column Name (display mode) -->
            <text 
              *ngIf="!(editingColumn.entityIndex === i && editingColumn.columnIndex === colIndex)"
              [attr.x]="entity.x + 50" 
              [attr.y]="entity.y + 89 + (colIndex * 32)" 
              class="column-name">
              {{ column.name }}
            </text>
            
            <!-- Column Type (display mode) -->
            <text 
              *ngIf="!(editingColumn.entityIndex === i && editingColumn.columnIndex === colIndex)"
              [attr.x]="entity.x + 160" 
              [attr.y]="entity.y + 89 + (colIndex * 32)" 
              class="column-type">
              {{ column.data_type }}
            </text>
            
            <!-- Edit Form (when editing) -->
            <g *ngIf="editingColumn.entityIndex === i && editingColumn.columnIndex === colIndex">
              <foreignObject 
                [attr.x]="entity.x + 50" 
                [attr.y]="entity.y + 73 + (colIndex * 32)"
                width="100" 
                height="24">
                <input 
                  [(ngModel)]="editingColumnName"
                  (blur)="saveColumnEdit(i, colIndex)"
                  (keydown.enter)="saveColumnEdit(i, colIndex)"
                  (keydown.escape)="cancelColumnEdit()"
                  type="text"
                  class="column-edit-input"
                  style="width: 100%; height: 20px; font-size: 12px; font-family: var(--font-sans); border: 1px solid var(--border-primary); border-radius: var(--radius-sm); background: var(--bg-card); color: var(--text-primary); padding: 2px 4px;">
              </foreignObject>
              
              <foreignObject 
                [attr.x]="entity.x + 160" 
                [attr.y]="entity.y + 73 + (colIndex * 32)"
                width="100" 
                height="24">
                <select 
                  [(ngModel)]="editingColumnType"
                  (change)="saveColumnEdit(i, colIndex)"
                  class="column-edit-select"
                  style="width: 100%; height: 20px; font-size: 11px; font-family: var(--font-mono); border: 1px solid var(--border-primary); border-radius: var(--radius-sm); background: var(--bg-card); color: var(--text-primary); padding: 1px 2px;">
                  <option *ngFor="let type of dataTypes" [value]="type">{{ type }}</option>
                </select>
              </foreignObject>
            </g>
            
            <!-- Edit Mode Actions (save/cancel) -->
            <g *ngIf="editingColumn.entityIndex === i && editingColumn.columnIndex === colIndex" class="column-actions">
              <!-- Save Icon (Tick) -->
              <circle 
                [attr.cx]="entity.x + entity.width - 45" 
                [attr.cy]="entity.y + 85 + (colIndex * 32)" 
                r="8"
                class="action-btn save-btn"
                (click)="saveColumnEdit(i, colIndex)"
                title="Save Changes">
              </circle>
              <svg 
                [attr.x]="entity.x + entity.width - 51" 
                [attr.y]="entity.y + 79 + (colIndex * 32)" 
                width="12" height="12" viewBox="0 0 24 24" class="action-icon">
                <path fill="none" stroke="white" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
              </svg>
              
              <!-- Cancel Icon (Cross) -->
              <circle 
                [attr.cx]="entity.x + entity.width - 25" 
                [attr.cy]="entity.y + 85 + (colIndex * 32)" 
                r="8"
                class="action-btn cancel-btn"
                (click)="cancelColumnEdit()"
                title="Cancel Changes">
              </circle>
              <svg 
                [attr.x]="entity.x + entity.width - 31" 
                [attr.y]="entity.y + 79 + (colIndex * 32)" 
                width="12" height="12" viewBox="0 0 24 24" class="action-icon">
                <path fill="none" stroke="white" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 6L6 18M6 6l12 12"></path>
              </svg>
            </g>

            <!-- Display Mode Actions (edit/delete) -->
            <g *ngIf="!(editingColumn.entityIndex === i && editingColumn.columnIndex === colIndex) && column.name !== 'new_column'" class="column-actions">
              <!-- Edit Icon -->
              <circle 
                [attr.cx]="entity.x + entity.width - 45" 
                [attr.cy]="entity.y + 85 + (colIndex * 32)" 
                r="8"
                class="action-btn edit-btn"
                (click)="startEditingColumn(i, colIndex)"
                title="Edit Column">
              </circle>
              <svg 
                [attr.x]="entity.x + entity.width - 51" 
                [attr.y]="entity.y + 79 + (colIndex * 32)" 
                width="12" height="12" viewBox="0 0 24 24" class="action-icon">
                <path fill="none" stroke="white" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
              </svg>
              
              <!-- Delete Icon -->
              <circle 
                [attr.cx]="entity.x + entity.width - 25" 
                [attr.cy]="entity.y + 85 + (colIndex * 32)" 
                r="8"
                class="action-btn delete-btn"
                (click)="deleteColumn(i, colIndex)"
                title="Delete Column">
              </circle>
              <svg 
                [attr.x]="entity.x + entity.width - 31" 
                [attr.y]="entity.y + 79 + (colIndex * 32)" 
                width="12" height="12" viewBox="0 0 24 24" class="action-icon">
                <path fill="none" stroke="white" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0 1 16.138 21H7.862a2 2 0 0 1-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 0 0-1-1h-4a1 1 0 0 0-1 1v3M4 7h16"></path>
              </svg>
            </g>
          </g>
        </g>
      </g>
    </svg>
  </div>

  <!-- Zoom Controls - Bottom Right -->
  <app-zoom-controls
    [zoom]="zoom"
    [minZoom]="minZoom"
    [maxZoom]="maxZoom"
    (zoomIn)="onZoomIn()"
    (zoomOut)="onZoomOut()"
    (resetZoom)="onResetZoom()"
    (fitToScreen)="onFitToScreen()">
  </app-zoom-controls>

  <!-- Changes Indicator -->
  <div *ngIf="hasChanges" class="changes-indicator">
    <div class="changes-badge">
      <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16c-.77.833.192 2.5 1.732 2.5z"></path>
      </svg>
      Unsaved Changes
    </div>
  </div>
</div>